name: üìä Audit Project Metrics

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üì¶ Instalar cloc (Count Lines of Code)
        run: sudo apt-get install -y cloc
      
      - name: üìä Contar arquivos e LOC
        id: metrics
        run: |
          echo "üìä Contando arquivos e linhas de c√≥digo..."
          
          # Contar total de arquivos (excluindo node_modules e build)
          TOTAL_FILES=$(find src -type f \( -name "*.tsx" -o -name "*.ts" -o -name "*.css" \) | wc -l)
          
          # Usar cloc para contar LOC (apenas c√≥digo, sem coment√°rios)
          cloc src --json --out=cloc_output.json
          TOTAL_LOC=$(jq '.SUM.code' cloc_output.json)
          
          # Breakdown por diret√≥rio
          COMPONENTS_LOC=$(cloc src/components --json 2>/dev/null | jq '.SUM.code // 0')
          PAGES_LOC=$(cloc src/pages --json 2>/dev/null | jq '.SUM.code // 0')
          HOOKS_LOC=$(cloc src/hooks --json 2>/dev/null | jq '.SUM.code // 0')
          CONTEXTS_LOC=$(cloc src/contexts --json 2>/dev/null | jq '.SUM.code // 0')
          EDGE_FUNCTIONS_LOC=$(cloc supabase/functions --json 2>/dev/null | jq '.SUM.code // 0')
          
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "total_loc=$TOTAL_LOC" >> $GITHUB_OUTPUT
          echo "components_loc=$COMPONENTS_LOC" >> $GITHUB_OUTPUT
          echo "pages_loc=$PAGES_LOC" >> $GITHUB_OUTPUT
          echo "hooks_loc=$HOOKS_LOC" >> $GITHUB_OUTPUT
          echo "contexts_loc=$CONTEXTS_LOC" >> $GITHUB_OUTPUT
          echo "edge_functions_loc=$EDGE_FUNCTIONS_LOC" >> $GITHUB_OUTPUT
          
          echo "‚úÖ M√©tricas calculadas:"
          echo "  - Total de arquivos: $TOTAL_FILES"
          echo "  - Total de LOC: $TOTAL_LOC"
      
      - name: üì§ Enviar m√©tricas para Backend
        env:
          SUPABASE_URL: https://kywmhuubbsvclkorxrse.supabase.co
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          PAYLOAD=$(jq -n \
            --argjson totalFiles "${{ steps.metrics.outputs.total_files }}" \
            --argjson totalLOC "${{ steps.metrics.outputs.total_loc }}" \
            --argjson componentsLOC "${{ steps.metrics.outputs.components_loc }}" \
            --argjson pagesLOC "${{ steps.metrics.outputs.pages_loc }}" \
            --argjson hooksLOC "${{ steps.metrics.outputs.hooks_loc }}" \
            --argjson contextsLOC "${{ steps.metrics.outputs.contexts_loc }}" \
            --argjson edgeFunctionsLOC "${{ steps.metrics.outputs.edge_functions_loc }}" \
            --arg commit "${{ github.sha }}" \
            --arg branch "${{ github.ref_name }}" \
            '{
              totalFiles: $totalFiles,
              totalLOC: $totalLOC,
              breakdown: {
                components: $componentsLOC,
                pages: $pagesLOC,
                hooks: $hooksLOC,
                contexts: $contextsLOC,
                edgeFunctions: $edgeFunctionsLOC
              },
              commit: $commit,
              branch: $branch,
              trigger: "github-actions"
            }')
          
          echo "üì¶ Payload constru√≠do:"
          echo "$PAYLOAD" | jq '.'
          
          echo ""
          echo "üöÄ Enviando requisi√ß√£o para Edge Function..."
          
          RESPONSE=$(curl -v -X POST \
            "${SUPABASE_URL}/functions/v1/audit-project-metrics" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            --data-binary @- \
            -w "\n%{http_code}" \
            -s <<EOF
$PAYLOAD
EOF
)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo ""
          echo "üìä Resposta recebida:"
          echo "Status Code: $HTTP_CODE"
          echo "Response Body:"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå Erro: Edge Function retornou status $HTTP_CODE"
            exit 1
          fi
          
          echo "‚úÖ M√©tricas enviadas com sucesso!"
      
      - name: üí¨ Comentar PR com m√©tricas (se for PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìä M√©tricas do Projeto\n\n` +
                    `- **Total de arquivos:** ${{ steps.metrics.outputs.total_files }}\n` +
                    `- **Linhas de c√≥digo:** ${{ steps.metrics.outputs.total_loc }}\n\n` +
                    `### Breakdown por diret√≥rio:\n` +
                    `- Components: ${{ steps.metrics.outputs.components_loc }} LOC\n` +
                    `- Pages: ${{ steps.metrics.outputs.pages_loc }} LOC\n` +
                    `- Hooks: ${{ steps.metrics.outputs.hooks_loc }} LOC\n` +
                    `- Contexts: ${{ steps.metrics.outputs.contexts_loc }} LOC\n` +
                    `- Edge Functions: ${{ steps.metrics.outputs.edge_functions_loc }} LOC`
            })
