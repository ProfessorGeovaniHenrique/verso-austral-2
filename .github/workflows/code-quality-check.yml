name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  scan-code:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Code Quality Scan
        id: scan
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
        run: |
          echo "ğŸ” Iniciando scan de qualidade do cÃ³digo..."
          
          # Chamar edge function de scan
          RESPONSE=$(curl -X POST "${SUPABASE_URL}/functions/v1/scan-codebase-realtime" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"scanType": "full", "compareWithBaseline": true}' \
            --silent \
            --show-error)
          
          echo "Response: $RESPONSE"
          
          # Extrair dados do JSON
          TOTAL_ISSUES=$(echo $RESPONSE | jq -r '.totalIssues // 0')
          CRITICAL_ISSUES=$(echo $RESPONSE | jq -r '.comparison.new | map(select(.severidade == "crÃ­tica")) | length // 0')
          NEW_ISSUES=$(echo $RESPONSE | jq -r '.comparison.new | length // 0')
          IMPROVEMENT=$(echo $RESPONSE | jq -r '.improvementPercentage // 0')
          
          echo "ğŸ“Š Resultados do Scan:"
          echo "  - Total de Issues: $TOTAL_ISSUES"
          echo "  - Issues CrÃ­ticos: $CRITICAL_ISSUES"
          echo "  - Novos Issues: $NEW_ISSUES"
          echo "  - Melhoria: $IMPROVEMENT%"
          
          # Exportar para prÃ³ximos steps
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "critical_issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
          echo "new_issues=$NEW_ISSUES" >> $GITHUB_OUTPUT
          echo "improvement=$IMPROVEMENT" >> $GITHUB_OUTPUT
      
      - name: Check Critical Issues
        if: steps.scan.outputs.critical_issues > 3
        run: |
          echo "âŒ BLOQUEADO: ${{ steps.scan.outputs.critical_issues }} bugs crÃ­ticos detectados!"
          echo ""
          echo "ğŸš« Este PR nÃ£o pode ser mergeado atÃ© que os bugs crÃ­ticos sejam corrigidos."
          echo ""
          echo "ğŸ“‹ Acesse /developer-logs na aplicaÃ§Ã£o para ver os detalhes completos."
          exit 1
      
      - name: Quality Gate Passed
        if: steps.scan.outputs.critical_issues <= 3
        run: |
          echo "âœ… Code Quality Check Passed!"
          echo ""
          echo "ğŸ“Š MÃ©tricas:"
          echo "  âœ“ Issues CrÃ­ticos: ${{ steps.scan.outputs.critical_issues }} (limite: 3)"
          echo "  â„¹ï¸ Total de Issues: ${{ steps.scan.outputs.total_issues }}"
          echo "  ğŸ“ˆ Taxa de Melhoria: ${{ steps.scan.outputs.improvement }}%"
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const criticalIssues = ${{ steps.scan.outputs.critical_issues }};
            const totalIssues = ${{ steps.scan.outputs.total_issues }};
            const improvement = ${{ steps.scan.outputs.improvement }};
            
            const status = criticalIssues <= 3 ? 'âœ…' : 'âŒ';
            const statusText = criticalIssues <= 3 ? 'APROVADO' : 'BLOQUEADO';
            const color = criticalIssues <= 3 ? 'ğŸŸ¢' : 'ğŸ”´';
            
            const body = `## ${status} Code Quality Check - ${statusText}
            
            ${color} **Status:** ${statusText}
            
            ### ğŸ“Š MÃ©tricas do Scan
            
            | MÃ©trica | Valor | Status |
            |---------|-------|--------|
            | Issues CrÃ­ticos | ${criticalIssues} | ${criticalIssues <= 3 ? 'âœ… OK' : 'âŒ Limite excedido'} |
            | Total de Issues | ${totalIssues} | â„¹ï¸ |
            | Taxa de Melhoria | ${improvement}% | ${improvement >= 50 ? 'âœ…' : 'âš ï¸'} |
            
            ${criticalIssues > 3 ? `
            ### ğŸš« AÃ§Ã£o NecessÃ¡ria
            
            Este PR possui **${criticalIssues} bugs crÃ­ticos** (limite: 3).
            
            Por favor, corrija os bugs crÃ­ticos antes de fazer merge.
            
            ğŸ“‹ Acesse \`/developer-logs\` na aplicaÃ§Ã£o para ver os detalhes completos.
            ` : `
            ### âœ¨ PrÃ³ximos Passos
            
            - Continue implementando as sugestÃµes de otimizaÃ§Ã£o da IA
            - Mantenha a qualidade do cÃ³digo alta
            - Monitore a taxa de melhoria no dashboard
            `}
            
            ---
            
            ğŸ’¡ **Dica:** Use o Dashboard de DevLogs para anÃ¡lise detalhada e sugestÃµes de correÃ§Ã£o automatizadas.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
